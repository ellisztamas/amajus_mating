---
title: "Untitled"
author: "Tom Ellis"
date: "3/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(reticulate)
library(tidyverse)

source("002.library/R/mating_events.R")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{python}
import numpy as np
import pandas as pd
from glob import glob
from tqdm import tqdm
import os
import seaborn as sns


from faps import posterior_mating
from amajusmating.dispersal import generalised_normal_PDF
from amajusmating import mating

np.random.seed(121)
burnin = 500

# FAPS objects and distance matrices are generated in a separate script.
exec(open('003.scripts/setup_FAPS_GPS.py').read())
# Make the matrix of distances into a dataframe
am_data.distance_df = pd.DataFrame({
    'mother'   : np.repeat(list(am_data.mothers), am_data.n_candidates),
    'father'   : np.tile(am_data.candidates, len(am_data.mothers)),
    'distance' : am_data.distances.flatten()
})
# Merge with flower colours
am_data.distance_df = am_data.distance_df.\
merge(am_data.flower_colours, how = 'left', left_on = "father", right_index = True)


sires = pd.read_csv(
  "005.results/011_fitness_all_genotypes/004_mcmc_restrict_kurtosis/sires.csv"
  )
sires.rename( columns={'Unnamed: 0':'iter', 'Unnamed: 1':'mating_event'}, inplace=True ) # rename index columns

# Merge with flower colour data
# sires = sires.merge(am_data.flower_colours, how = 'left', left_on = "father", right_index = True)
# Merge with distances
sires = sires.merge(am_data.distance_df, how = 'left', on = ["mother", "father"])
# Remove candidates with no distance info
sires = sires.loc[~sires['distance'].isnull()].reset_index()

```

```{r}
this_colour <- py$am_data$flower_colours %>% 
  filter(simple_colour != "unkown") %>%
  row.names()

sires  <- as.data.frame(py$sires)
sires <- sires %>%
  filter(
    # simple_colour %in% c("FR", "hybrid", "Ye"),
    mother %in% this_colour
    ) %>% 
  mutate(
    simple_colour = as.factor(simple_colour),
    # Reticulate does something funny to `rosea` and `sulfurea`, so they need to be converted back to vectors
    rosea = as.factor(unlist(sires$rosea)),
    sulfurea = as.factor(unlist(sires$sulfurea))
  )

distance_df <- py$am_data$distance_df
distance_df <- distance_df %>% 
  mutate(
    # Reticulate does something funny to `rosea` and `sulfurea`, so they need to be converted back to vectors
    rosea = as.factor(unlist(distance_df$rosea)),
    sulfurea = as.factor(unlist(distance_df$sulfurea))
  ) %>%   
  filter(
    !is.na(distance),
    distance <= 2000,
    mother != father,
    mother %in% this_colour
  )

# bins <- seq(0,2000,50)
bins <-c(0, 2.3, 5.8,9.5, 17.5, 30, 51, 90, 154, 303, 2000)
sires$bins <- cut(sires$distance, bins)
distance_df$bins <- cut(distance_df$distance, bins)


# x <- 
sires %>%
  filter (iter == 500) %>%
  arrange(distance) %>%
  mutate(
    cumsum = cumsum(prob),
    cumsum = cumsum / max(cumsum)) %>%
  filter(cumsum > 0.5) %>% 
  arrange(cumsum) %>% head
pull(cumsum) %>%
  quantile(seq(0,1, 0.1))

sires %>%
  # filter (iter == 500) %>%
  arrange(distance) %>%
  mutate(cumsum = cumsum(prob) ) %>%
  filter(cumsum < x[6]) %>%
  tail() %>%
  select(distance)


sires %>% 
  group_by(iter) %>% 
  summarise(
    i = seq(0.1, 1, 0.1),
    q = quantile(distance, seq(0.1, 1, 0.1))
  ) %>% 
  group_by(i) %>% 
  summarise(
    d = mean(q)
  )


```


```{r}

iter <- unique(sires$iter)

mating_events <- vector('list', length(iter))

# Initializes the progress bar
pb <- txtProgressBar(min = 0, max = max(iter), style = 3) 
for(i in iter){
  setTxtProgressBar(pb, i)
  
  these_sires <- sires %>%
    filter(iter == i)
  
  # Add a weight to the data frame of distances to all males reflecting how many
  # mating events came from each mother.
  w <- these_sires %>% 
    group_by(mother) %>% 
    summarise(
      prob = sum(prob)
    ) %>% 
    mutate(
      prob = prob / max(prob)
    ) 
  these_non_sires <- distance_df %>% 
    left_join(w, by = 'mother')
  
  these_sires$two_locus <- paste(these_sires$rosea, these_sires$sulfurea, sep = "_")
  these_non_sires$two_locus <- paste(these_non_sires$rosea, these_non_sires$sulfurea, sep = "_")
  
  me <- cumulative_mating_events(
    these_sires,# %>% filter(mother %in% this_colour),
    these_non_sires,# %>% filter(mother %in% this_colour),
    bins = 'bins',
    phenotype = 'two_locus',
    weights = 'prob'
  )
  me$iter <- i
  
  # send the output to mating_events.
  # The +1 is to account for Python counting from 0, not 1.
  mating_events[[i + 1]] <- me
}
close(pb) # Close the connection

# Glue the list together
mating_events <- do.call('rbind', mating_events)
```

```{r}
library(stringr)
sapply(str_extract_all(mating_events$bins, "-?[0-9.]+"), function(x) max(as.numeric(x)))


mating_events %>% 
  
  filter(
    phenotype != "NaN_NaN"
  ) %>% 
  group_by(type, bins, phenotype) %>% 
  summarise(
    lower = quantile(cumsum, 0.02),
    upper = quantile(cumsum, 0.98),
    .groups = 'drop'
  ) %>% 
  pivot_longer(lower:upper) %>% 
  ggplot( aes(x= bins, y = value, colour = type, group = paste0(name,type)) ) +
  geom_line() +
  labs(
    x = "Distance (m)",
    y = "Cumulative number of mating events"
  ) +
  scale_x_discrete(labels=paste0("<",bins[-1])) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid( ~phenotype)
```


```{r}

mating_events %>% 
  filter(
    phenotype != "NaN_NaN"
  ) %>% 
  group_by(type, bins, phenotype) %>% 
  summarise(
    lower = quantile(n_sires, 0.02),
    upper = quantile(n_sires, 0.98),
    .groups = 'drop'
  ) %>% 
  pivot_longer(lower:upper) %>% 
  ggplot( aes(x= bins, y = value, colour = type, group = paste0(name,type)) ) +
  geom_line() +
  # scale_y_log10() +
  labs(
    x = "Distance",
    y = "Number of mating events"
  ) +
  # annotation_logticks(sides = "l") +
  facet_grid( ~phenotype)

```


```{r}
py$distance_df %>% 
  mutate(
    match = (simple_colour_father == simple_colour_mother),
    bin = cut(distance, seq(0,2000,100))
    ) %>% 
  group_by(bin) %>% 
  summarise(
    ass = mean(match, na.rm=TRUE),
    n = n(),
    distance = median(distance)
  ) %>% 
  ggplot(aes(x = distance, y = ass)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  lims(
    y = c(0,1)
  )
  
```


```{r}
obs = tibble(py$obs)

obs %>% 
  arrange(distance) %>% 
  mutate(
    match = (rosea_father == rosea_mother),
    bin = rep(letters[1:22], each= 10)
    ) %>% 
  group_by(bin) %>% 
  summarise(
    ass = mean(match, na.rm=TRUE),
    dist = median(distance),
    n = n()
  ) %>% 
  ggplot(aes(x = dist, y = ass)) +
  geom_line()

obs %>% 
  mutate(
    match = (simple_colour_father == simple_colour_mother),
    bin = cut(distance, seq(0,2000,100))
    ) %>% 
  group_by(bin) %>% 
  summarise(
    ass = mean(match, na.rm=TRUE),
    n = n(), 
    distance = median(distance)
  ) %>% 
  ggplot(aes(x = distance, y = ass)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
obs %>% 
  mutate(
    match = (simple_colour_father == simple_colour_mother),
    bin = cut(distance, seq(0,2000,100))
    ) %>% 
  group_by(bin, simple_colour_father) %>% 
  summarise(
    # mean = mean(na.rm=TRUE),
    n = n(), 
    distance = median(distance)
  ) %>% 
  group_by(simple_colour_father) %>% 
  group_split() %>% 
  lapply(., function(x) x %>% mutate(cum = cumsum(x$n))) %>% 
  do.call(what = 'rbind') %>% 
  ggplot(aes(x = bin, y = cum, colour = simple_colour_father, group = simple_colour_father)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



obs %>% 
  mutate(
    bin = cut(distance, seq(0,2000,100))
    ) %>% 
  group_by(bin, simple_colour_father) %>% 
  summarise(
    n = n(), 
    distance = median(distance)
    ) %>% 
  group_by(bin, .drop = FALSE) %>% 
  summarise(
    simple_colour_father = simple_colour_father,
    distance = distance,
    n = n,
    norm = n / sum(n),
    .groups = 'drop'
  ) %>% 
  group_by(simple_colour_father) %>% 
  group_split() %>% 
  lapply(., function(x) x %>% mutate(cum = cumsum(x$norm))) %>% 
  do.call(what = 'rbind') %>% 
  mutate(cum = cum/ max(cum)) %>% 
  ggplot(aes(x = distance, y = cum, colour = simple_colour_father, group = simple_colour_father)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
py$distance_df %>% 
  filter(simple_colour_father != "unkown") %>% 
  mutate(
    bin = cut(distance, seq(0,2000,100))
    ) %>% 
  group_by(bin, simple_colour_father, .drop = FALSE) %>% 
  summarise(
    n = n(), 
    distance = median(distance),
    .groups = 'drop'
    ) %>% 
  group_by(bin) %>% 
  summarise(
    simple_colour_father = simple_colour_father,
    distance = distance,
    n = n,
    norm = n / sum(n),
    .groups = 'drop'
  ) %>% 
  group_by(simple_colour_father) %>% 
  group_split() %>% 
  lapply(., function(x) x %>% mutate(cum = cumsum(x$n))) %>% 
  do.call(what = 'rbind') %>% 
  mutate(cum = cum/ max(cum)) %>% 
  ggplot(aes(x = distance, y = cum, colour = simple_colour_father, group = simple_colour_father)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
```


```{r}

obs %>% 
  mutate(
    bin = cut(distance, seq(0,2000,100))
    ) %>% 
  group_by(bin, simple_colour_father, simple_colour_mother) %>% 
  summarise(
    n = n(), 
    distance = median(distance)
  ) %>% 
  mutate(
    phen = paste0(simple_colour_father,simple_colour_mother)
  ) %>% 
  ggplot( aes(
      x = bin, y = n,
      colour = simple_colour_father,
      shape = simple_colour_mother,
      group = phen
    )) +
      geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

obs %>% 
  mutate(
    bin = cut(distance, seq(0,2000,100))
    ) %>% 
  group_by(bin, simple_colour_father, simple_colour_mother) %>% 
  summarise(
    n = n(), 
    distance = median(distance)
  ) %>% 
  group_by(bin) %>% 
  summarise(
    simple_colour_father = simple_colour_father,
    simple_colour_mother = simple_colour_mother,
    n = n,
    norm = n / sum(n),
    .groups = 'drop'
  ) %>% 
  mutate(
    phen = paste0(simple_colour_father,simple_colour_mother)
  ) %>% 
  ggplot( aes(
      x = bin, y = norm,
      colour = simple_colour_father,
      shape = simple_colour_mother,
      group = phen
    )) +
      geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

